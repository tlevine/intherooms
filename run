#!/bin/sh
set -e

# Activate
env|grep '^IN_THE_ROOMS_ROOT=' || . ./activate

# Go through search pages
./download_searches.py

# This doesn't really detect the database's current state, so delete it and
# rebuild if something goes wrong.

# Schema
test -e "$IN_THE_ROOMS_ROOT/intherooms.db" ||
    sqlite3 "$IN_THE_ROOMS_ROOT/intherooms.db" < schema.sql

# Parse those pages.
for coords in $(ls -d searches-usa/*|cut -d/ -f2); do
    for page in $(ls searches/*|cut -d. -f1|cut -d\/ -f2); do
        if test $(sqlite3 $IN_THE_ROOMS_ROOT/intherooms.db "SELECT count(*) FROM meeting_search WHERE [Search Page] = $page AND [Search Longitude] || ',' || [Search Latitude] = '$coords';") -eq 0 ; then
            ./parse_search.py $coords $page
        else
            echo Page $page has already been parsed.
        fi
    done
done

# Manually fix some weird records.
sqlite3 "$IN_THE_ROOMS_ROOT/intherooms.db" < manual_fixes.sql

./download_all_meetings.sh "$IN_THE_ROOMS_ROOT/intherooms.db"
./download_all_locations.sh "$IN_THE_ROOMS_ROOT/intherooms.db"
./parse_all_meetings.sh "$IN_THE_ROOMS_ROOT/intherooms.db"
./parse_all_locations.sh "$IN_THE_ROOMS_ROOT/intherooms.db"
./parse_meeting-description.py
